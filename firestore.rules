/**
 * @fileoverview Firestore Security Rules for JasTip Express application.
 *
 * Core Philosophy:
 * This ruleset employs a strict path-based ownership model for user data,
 * ensuring that users can only access their own information. Top-level
 * collections like "events" are publicly readable but owner-writeable.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the authenticated user can
 *   read/write their own profile.
 * - /users/{userId}/orders/{orderId}: Stores orders associated with a user.
 *   Only the authenticated user can read/write orders under their ID.
 * - /users/{userId}/orders/{orderId}/notas/{notaId}: Stores notas/receipts
 *   related to a specific order. Only the authenticated user can
 *   read/write notas under their ID and order.
 * - /events/{eventId}: Stores Jastip events. Publicly readable, but
 *   create/update/delete operations are restricted to the event owner.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Public read access is granted to the "events" collection to allow
 *   unauthenticated users to view event information, but write access is
 *   restricted to the event owner.
 *
 * Denormalization for Authorization:
 *   The data structure is designed to avoid `get()` calls in security rules.
 *   For example, orders are stored under `/users/{userId}/orders/{orderId}`,
 *   allowing rules to directly check the `userId` in the path without
 *   needing to fetch the user document.
 *
 * Structural Segregation:
 *   Private user data (profiles, orders, notas) is stored under the
 *   `/users/{userId}` path, while public event data is stored in the top-level
 *   `/events` collection. This segregation allows for different security
 *   policies for private and public data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Requires the user to be authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Enforces user ownership based on the authenticated user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

     /**
      * @description Checks if the authenticated user is the existing owner of the resource.
      * @path N/A (Helper Function)
      * @allow N/A (Helper Function)
      * @deny N/A (Helper Function)
      * @principle Combines ownership check with existence check for update/delete operations.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Defines security rules for user documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their own profile.
     * @allow (get, update, delete) Authenticated user 'user123' accesses their own profile.
     * @deny (create) User with ID 'user456' attempts to create a profile with ID 'user123'.
     * @deny (get, update, delete) Authenticated user 'user456' attempts to access profile 'user123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for order documents within a user's profile.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create) User with ID 'user123' creates an order under their profile.
     * @allow (get, update, delete) Authenticated user 'user123' accesses their own order.
     * @deny (create) User with ID 'user456' attempts to create an order under user 'user123'.
     * @deny (get, update, delete) Authenticated user 'user456' attempts to access order under user 'user123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for nota documents within an order.
     * @path /users/{userId}/orders/{orderId}/notas/{notaId}
     * @allow (create) User with ID 'user123' creates a nota under their order.
     * @allow (get, update, delete) Authenticated user 'user123' accesses their own nota.
     * @deny (create) User with ID 'user456' attempts to create a nota under user 'user123'.
     * @deny (get, update, delete) Authenticated user 'user456' attempts to access nota under user 'user123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/orders/{orderId}/notas/{notaId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for Jastip event documents.
     * @path /events/{eventId}
     * @allow (get, list) Any user can read event information.
     * @allow (create) Authenticated user creates a new event with correct owner.
     * @allow (update, delete) Authenticated user who owns the event can modify/delete it.
     * @deny (create) Unauthenticated user attempts to create a new event.
     * @deny (update, delete) Authenticated user attempts to modify/delete an event they don't own.
     * @principle Allows public read access but restricts write access to the event owner.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}