/**
 * @fileoverview Firestore Security Rules for JasTip Express Prototyping.
 *
 * Core Philosophy:
 * This ruleset prioritizes strict user-ownership for personal data and allows public read access to Jastip events.
 * Data validation is relaxed to enable rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /users/{userId}/orders/{orderId}: Stores orders placed by a specific user.
 * - /users/{userId}/orders/{orderId}/notas/{notaId}: Stores receipts (notas) for specific orders.
 * - /events/{eventId}: Stores information about Jastip events (public).
 *
 * Key Security Decisions:
 * - Users can only access their own data within the /users/{userId} tree.
 * - Jastip events are publicly readable.
 *
 * Denormalization for Authorization:
 * - The `orders` and `notas` collections are nested under `/users/{userId}` to avoid needing to store redundant `userId` properties inside those documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profile information.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile.
     * @allow (get, list, update, delete) - Authenticated user accesses their own profile.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId);
    }

    /**
     * @description Allows access to orders associated with a specific user.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create) - Authenticated user creates an order under their own profile.
     * @allow (get, list, update, delete) - Authenticated user accesses their own orders.
     * @deny (create, get, list, update, delete) - Any other user attempts to access these orders.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/orders/{orderId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId);
    }

    /**
     * @description Allows access to notas associated with a specific order.
     * @path /users/{userId}/orders/{orderId}/notas/{notaId}
     * @allow (create) - Authenticated user creates a nota under their own order.
     * @allow (get, list, update, delete) - Authenticated user accesses their own notas.
     * @deny (create, get, list, update, delete) - Any other user attempts to access these notas.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/orders/{orderId}/notas/{notaId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to Jastip events.
     * @path /events/{eventId}
     * @allow (get, list) - Any user (or no user) can read event details.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete events (TODO: add admin validation if required).
     * @principle Public read access with authenticated writes.
     */
    match /events/{eventId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create, update, delete: if isSignedIn(); // TODO: Add owner validation or admin role if required
    }
  }
}